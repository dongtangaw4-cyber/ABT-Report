<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ระบบผู้ดูแล | ABT Report</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="icon" href="icon192.png">
<link rel="apple-touch-icon" href="icon512.png">

<style>
  :root{ --card-w:1100px; }

  html,body{height:100%}
  body{
    margin:0; font-family:Kanit,system-ui;
    background:url('Backgroundธีม.png') center/cover no-repeat fixed;
  }

  /* การ์ด/ตาราง */
  .card{
    width:min(var(--card-w),94vw); margin:32px auto; background:#fff;
    border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.12); padding:18px;
  }
  h1{margin:6px 0 16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:0 0 10px}
  input,select,button{padding:10px;border:1px solid #e5e7eb;border-radius:10px;font-family:inherit}
  button{cursor:pointer;background:#16a34a;color:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;vertical-align:top}
  th{background:#f3f4f6;text-align:left;position:sticky;top:0}
  .thumb{width:64px;height:64px;object-fit:cover;border-radius:8px}
  .pill{padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
  .s-รับเรื่องแล้ว{background:#e0f2fe;color:#0369a1}
  .s-กำลังดำเนินการ{background:#fef9c3;color:#854d0e}
  .s-เสร็จสิ้น{background:#dcfce7;color:#166534}
  .muted{color:#777}

  /* กล่องล็อกอิน (PIN) */
  .gate-wrap{min-height:100vh; display:grid; place-items:center;}
  .glass{
    background: rgba(255,255,255,.7);         /* สีขาวใส */
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);               /* เบลอพื้นหลังจริง */
    border-radius:16px;
    box-shadow:0 16px 40px rgba(0,0,0,.18);
    padding:22px;
    width:min(500px,92vw);
    text-align:center;
  }
  
  #logo-left { width:122px; height:122px; }
  
  .logo-row{
    display:flex; justify-content:center; align-items:center; gap:18px; margin-bottom:8px;
  }
  .logo-row img{
    width:110px; height:110px; object-fit:contain; border-radius:50%; background:#fff;
    display:block;
  }
  .gate-title{ margin:8px 0 12px; font-weight:700; font-size:22px; }
  .gate-hint{ color:#6b7280; font-size:13px; margin-top:10px; }
  .pin-input{
    width:100%; max-width:420px; font-size:18px; padding:8px 12px;
    border:2px solid #16a34a; border-radius:12px; outline:none;
    margin:0 auto 10px auto; display:block;
  }
  .pin-btn{
    width:160px; padding:10px; border:0; border-radius:10px;
    background:#16a34a; color:#fff; font-weight:700; cursor:pointer;
  }
</style>
</head>
<body>

<!-- ========== กล่องใส่ PIN ========== -->
<div id="gate" class="gate-wrap">
  <div class="glass">
    <div class="logo-row">
      <img id="logo-left" src="logo.png" alt="โลโก้ซ้าย">
	  <img src="icon.png" alt="โลโก้ขวา">
    </div>

    <div class="gate-title">เข้าสู่ระบบผู้ดูแล / ADMIN</div>

    <form id="pinForm" autocomplete="off">
      <input id="pin" class="pin-input" type="password" inputmode="numeric" pattern="[0-9]*"
             placeholder="กรอกรหัสผ่านสำหรับผู้ดูแลระบบ">
      <button id="btnLogin" class="pin-btn" type="submit">เข้าสู่ระบบ</button>
    </form>

    <div class="gate-hint">* สำหรับเจ้าหน้าที่เท่านั้น</div>
  </div>
</div>

<!-- ========== หน้าจอแอดมิน ========== -->
<main id="app" style="display:none">
  <div class="card">
    <h1>ระบบผู้ดูแล – ศูนย์รับแจ้งปัญหา อบต.ดงตะงาว</h1>

    <div class="toolbar">
      <input id="q" placeholder="ค้นหา: ชื่อ/ประเภท/รายละเอียด">
      <select id="status">
        <option value="">ทั้งหมด (ทุกสถานะ)</option>
        <option>รับเรื่องแล้ว</option>
        <option>กำลังดำเนินการ</option>
        <option>เสร็จสิ้น</option>
      </select>
      <button id="btnRefresh" type="button">รีเฟรช</button>
      <button id="btnLogout" type="button" style="background:#ef4444">ออกจากระบบ</button>
      <span id="err" class="muted"></span>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:150px">เวลา</th>
            <th style="width:160px">ผู้แจ้ง</th>
            <th>ประเภท / รายละเอียด</th>
            <th style="width:90px">รูป</th>
            <th style="width:140px">พิกัด</th>
            <th style="width:120px">สถานะ</th>
            <th style="width:140px">จัดการ</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7" class="muted">กำลังโหลด…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script type="module">
  /* ---------------- PIN login (ออฟไลน์ได้) ---------------- */
  const ADMIN_PIN = '651103';              // <- เปลี่ยนรหัสที่นี่
  const KEY = 'abt_admin_login_ok';

  const gate = document.getElementById('gate');
  const pinForm = document.getElementById('pinForm');
  const elPin = document.getElementById('pin');
  const app = document.getElementById('app');
  const btnLogout = document.getElementById('btnLogout');
  const elQ = document.getElementById('q');
  const elStatus = document.getElementById('status');
  const elRefresh = document.getElementById('btnRefresh');
  const elRows = document.getElementById('rows');

  let cache = [];
  let unsubscribe = null;

  function showGate(){ gate.style.display='grid'; app.style.display='none'; elPin.value=''; setTimeout(()=>elPin.focus(),0); }
  function showApp(){ gate.style.display='none'; app.style.display=''; }

  const fmtTime = ts => {
    if (!ts) return '-';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString('th-TH',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  };

  function render(){
    const kw = (elQ?.value||'').trim().toLowerCase();
    const st = (elStatus?.value||'').trim();
    const rows = cache.filter(r=>{
      const blob = `${r.name||''} ${r.category||''} ${r.detail||''}`.toLowerCase();
      return (!kw || blob.includes(kw)) && (!st || r.status===st);
    }).map(r=>`
      <tr>
        <td>${fmtTime(r.createdAt)}</td>
        <td>
          <div><b>${r.name||'-'}</b></div>
          <div class="muted">${r.phone||''}</div>
          <div class="muted">${r.address||''}</div>
        </td>
        <td>
          <div><b>${r.category||'-'}</b></div>
          <div class="muted">${r.detail||''}</div>
        </td>
        <td>${r.photo?`<a href="${r.photo}" target="_blank" rel="noopener"><img class="thumb" src="${r.photo}"></a>`:'-'}</td>
        <td>${r.lat&&r.lng?`<div>${r.lat}, ${r.lng}</div><a href="https://www.google.com/maps?q=${r.lat},${r.lng}" target="_blank">เปิดแผนที่</a>`:'-'}</td>
        <td><span class="pill s-${r.status||'รับเรื่องแล้ว'}">${r.status||'รับเรื่องแล้ว'}</span></td>
        <td>
          <button data-id="${r._id}" data-next="กำลังดำเนินการ">กำลังดำเนินการ</button>
          <button data-id="${r._id}" data-next="เสร็จสิ้น" style="background:#0ea5e9;margin-top:6px">เสร็จสิ้น</button>
        </td>
      </tr>`).join('');
    elRows.innerHTML = rows || `<tr><td colspan="7" class="muted">ไม่พบข้อมูล</td></tr>`;
  }

  // โหลด Firebase เฉพาะหลังล็อกอิน
  async function startSubscribe(){
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js');
    const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js');
    const { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp }
      = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyDR8hVqZ1uDrjRMjK6u_rWO6c7Cs5-vDXw",
      authDomain: "abt-report.firebaseapp.com",
      projectId: "abt-report",
      storageBucket: "abt-report.appspot.com",
      messagingSenderId: "166748459797",
      appId: "1:166748459797:web:0cf5693e43a551142a8f1c"
    };

    const fb = initializeApp(firebaseConfig);
    const auth = getAuth(fb);
    const db = getFirestore(fb);

    await signInAnonymously(auth);

    if (unsubscribe) unsubscribe();
    const qReports = query(collection(db,'reports'), orderBy('createdAt','desc'));
    unsubscribe = onSnapshot(qReports, snap=>{
      cache = snap.docs.map(d=>({_id:d.id, ...d.data()}));
      render();
    }, err=>{
      elRows.innerHTML = `<tr><td colspan="7" class="muted">โหลดข้อมูลไม่สำเร็จ: ${err.message}</td></tr>`;
    });

    // เปลี่ยนสถานะ
    elRows.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-id]');
      if(!b) return;
      try{
        await updateDoc(doc(db,'reports',b.dataset.id), { status:b.dataset.next, updatedAt:serverTimestamp() });
      }catch(err){ alert('อัปเดตไม่สำเร็จ: '+err.message); }
    });
  }

  // สถานะเริ่มต้น
  if (localStorage.getItem(KEY)==='1'){ showApp(); startSubscribe().catch(console.error); }
  else{ showGate(); }

  // ล็อกอิน
  pinForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    if ((elPin.value||'').trim() === ADMIN_PIN){
      localStorage.setItem(KEY,'1');
      elPin.value='';
      showApp();
      startSubscribe().catch(err=>alert('เชื่อมต่อฐานข้อมูลไม่สำเร็จ: '+err.message));
    }else{
      alert('PIN ไม่ถูกต้อง'); elPin.select();
    }
  });

  // ออกจากระบบ
  btnLogout.addEventListener('click', ()=>{
    localStorage.removeItem(KEY);
    if (unsubscribe){ unsubscribe(); unsubscribe=null; }
    elRows.innerHTML = `<tr><td colspan="7" class="muted">ออกจากระบบแล้ว</td></tr>`;
    showGate();
  });

  // ค้นหา/กรอง/รีเฟรช
  elQ?.addEventListener('input', render);
  elStatus?.addEventListener('change', render);
  elRefresh?.addEventListener('click', render);
</script>
</body>
</html>